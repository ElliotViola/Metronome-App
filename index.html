<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metronome App</title>
    <!-- Tailwind CSS CDN - All styling is done with Tailwind classes directly in HTML -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for hiding number input spin buttons across browsers */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='number'] {
            -moz-appearance: textfield;
        }

        /* Base font for the entire application */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Keyframe animations for various elements (already optimized for direct CSS) */
        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100vh) rotate(0deg) scale(1);
            }
            100% {
                opacity: 1;
                transform: translateY(100vh) rotate(720deg) scale(1);
            }
        }
        .animate-confetti-fall {
            animation-name: confetti-fall;
            animation-fill-mode: forwards;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes pulse-grow {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-popup-grow {
            animation: pulse-grow 0.5s ease-out forwards;
        }

        @keyframes text-flash {
            0%, 100% { color: #16a34a; }
            50% { color: #facc15; }
        }
        .animate-text-flash {
            animation: text-flash 0.5s infinite alternate;
        }

        @keyframes text-flash-alt {
            0%, 100% { color: #8b5cf6; }
            50% { color: #ef4444; }
        }
        .animate-text-flash-alt {
            animation: text-flash-alt 0.5s infinite alternate;
        }

        @keyframes brain-pop {
            0% { transform: scale(0) translateY(100px); opacity: 0; }
            80% { transform: scale(1.1) translateY(-10px); opacity: 1; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .animate-brain-pop {
            animation: brain-pop 0.8s ease-out forwards;
        }

        @keyframes brain-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-brain-pulse {
            animation: brain-pulse 1.5s infinite alternate ease-in-out;
        }

        @keyframes sign-swing {
            0% { transform: rotate(-10deg); opacity: 0; }
            20% { opacity: 1; }
            50% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); opacity: 1; }
        }
        .animate-sign-swing {
            animation: sign-swing 1s ease-out forwards 0.5s;
        }

        @keyframes sign-wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-2deg); }
            75% { transform: rotate(2deg); }
        }
        .animate-sign-wobble {
            animation: sign-wobble 0.7s infinite alternate ease-in-out 1.5s;
        }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import * as Tone from 'https://esm.sh/tone@14.7.77';

        // Helper function to get SVG icon for subdivision types (Rectangular Visuals)
        const getSubdivisionVisual = (type, isSelected = false) => {
          const filledColor = isSelected ? '#A78BFA' : '#8B5CF6'; // Purple for filled parts
          const viewBoxWidth = 20; // Smaller viewBox for better scaling
          const viewBoxHeight = 5; // Smaller viewBox for better scaling
          const gap = 0.5; // Gap between segments in viewBox units

          const Rect = ({ x, width, fill }) => (
            React.createElement('rect', { x: x, y: '0', width: width, height: '5', rx: '0.5', ry: '0.5', fill: fill })
          );

          switch (type) {
            case 'none': // Crotchet (Quarter Note) - One full block
              return (
                React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' },
                  React.createElement(Rect, { key: 'none-rect', x: '0', width: viewBoxWidth, fill: filledColor })
                )
              );
            case 'straight8ths': // 2x Quavers (Two 8th Notes) - Two half blocks
              const halfWidth = (viewBoxWidth - gap) / 2;
              return (
                React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' },
                  React.createElement(Rect, { key: 'straight8ths-1', x: '0', width: halfWidth, fill: filledColor }),
                  React.createElement(Rect, { key: 'straight8ths-2', x: halfWidth + gap, width: halfWidth, fill: filledColor })
                )
              );
            case 'triplet_full': // Three 8th-note Triplets - Three third blocks
              const thirdWidth = (viewBoxWidth - 2 * gap) / 3;
              return (
                React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' },
                  React.createElement(Rect, { key: 'triplet-1', x: '0', width: thirdWidth, fill: filledColor }),
                  React.createElement(Rect, { key: 'triplet-2', x: thirdWidth + gap, width: thirdWidth, fill: filledColor }),
                  React.createElement(Rect, { key: 'triplet-3', x: 2 * (thirdWidth + gap), width: thirdWidth, fill: filledColor })
                )
              );
            case 'dotted8th16th': // Dotted Quaver + Semiquaver (Dotted 8th + 16th) - 3/4 + 1/4 blocks
              const threeQuarterWidth = (viewBoxWidth - gap) * 0.75;
              const oneQuarterWidth = (viewBoxWidth - gap) * 0.25;
              return (
                React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' },
                  React.createElement(Rect, { key: 'dotted8th16th-1', x: '0', width: threeQuarterWidth, fill: filledColor }),
                  React.createElement(Rect, { key: 'dotted8th16th-2', x: threeQuarterWidth + gap, width: oneQuarterWidth, fill: filledColor })
                )
              );
            case 'sixteenth_dotted8th': // Semiquaver + Dotted Quaver (16th + Dotted 8th) - 1/4 + 3/4 blocks
              const oneQuarterWidth_inv = (viewBoxWidth - gap) * 0.25;
              const threeQuarterWidth_inv = (viewBoxWidth - gap) * 0.75;
              return (
                React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' },
                  React.createElement(Rect, { key: 'sixteenth-dotted8th-1', x: '0', width: oneQuarterWidth_inv, fill: filledColor }),
                  React.createElement(Rect, { key: 'sixteenth-dotted8th-2', x: oneQuarterWidth_inv + gap, width: threeQuarterWidth_inv, fill: filledColor })
                )
              );
            default:
              return React.createElement('svg', { width: '100%', height: '100%', viewBox: `0 0 ${viewBoxWidth} ${viewBoxHeight}`, preserveAspectRatio: 'xMidYMid meet' });
          }
        };

        // WheelPicker Component
        const WheelPicker = ({ options, selectedValue, onValueChange, itemHeight, displayTransform = (val) => val, className }) => {
          const wheelRef = useRef(null);
          const startY = useRef(0);
          const startScrollTop = useRef(0);
          const isDraggingWheel = useRef(false);
          const currentAnimationFrame = useRef(null);

          const paddingItemsCount = 2;
          const paddedOptions = [
            ...Array(paddingItemsCount).fill(null),
            ...options,
            ...Array(paddingItemsCount).fill(null),
          ];

          useEffect(() => {
            if (wheelRef.current) {
              const initialIndex = options.indexOf(selectedValue);
              if (initialIndex !== -1) {
                const targetScrollTop = ((initialIndex + paddingItemsCount) * itemHeight) - (wheelRef.current.clientHeight / 2) + (itemHeight / 2);
                wheelRef.current.scrollTop = targetScrollTop;
              }
            }
          }, [options, selectedValue, itemHeight, paddingItemsCount]);

          const handleWheelStart = (e) => {
            e.preventDefault();
            isDraggingWheel.current = true;
            startY.current = e.clientY || e.touches[0].clientY;
            startScrollTop.current = wheelRef.current.scrollTop;

            if (currentAnimationFrame.current) {
              cancelAnimationFrame(currentAnimationFrame.current);
            }

            window.addEventListener('mousemove', handleWheelMove);
            window.addEventListener('mouseup', handleWheelEnd);
            window.addEventListener('touchmove', handleWheelMove, { passive: false });
            window.addEventListener('touchend', handleWheelEnd);
          };

          const handleWheelMove = useCallback((e) => {
            if (!isDraggingWheel.current) return;
            e.preventDefault();

            const currentY = e.clientY || e.touches[0].clientY;
            const deltaY = currentY - startY.current;

            wheelRef.current.scrollTop = startScrollTop.current - deltaY;

            const centerOffset = wheelRef.current.clientHeight / 2;
            const scrollCenter = wheelRef.current.scrollTop + centerOffset;
            const newPaddedIndex = Math.round((scrollCenter - itemHeight / 2) / itemHeight);
            const newActualIndex = newPaddedIndex - paddingItemsCount;

            const clampedActualIndex = Math.max(0, Math.min(options.length - 1, newActualIndex));
            const newValue = options[clampedActualIndex];
            if (newValue !== selectedValue) {
              onValueChange(newValue);
            }
          }, [options, itemHeight, selectedValue, onValueChange, paddingItemsCount]);

          const handleWheelEnd = useCallback(() => {
            isDraggingWheel.current = false;
            window.removeEventListener('mousemove', handleWheelMove);
            window.removeEventListener('mouseup', handleWheelEnd);
            window.removeEventListener('touchmove', handleWheelMove);
            window.removeEventListener('touchend', handleWheelEnd);

            const currentScrollTop = wheelRef.current.scrollTop;
            const closestPaddedIndex = Math.round((currentScrollTop + wheelRef.current.clientHeight / 2 - itemHeight / 2) / itemHeight);
            const finalActualIndex = Math.max(0, Math.min(options.length - 1, closestPaddedIndex - paddingItemsCount));

            onValueChange(options[finalActualIndex]);

            wheelRef.current.scrollTo({
              top: ((finalActualIndex + paddingItemsCount) * itemHeight) - (wheelRef.current.clientHeight / 2) + (itemHeight / 2),
              behavior: 'smooth',
            });
          }, [options, itemHeight, onValueChange, paddingItemsCount]);

          const wheelContainerStyle = {
            height: '200px',
            overflowY: 'scroll',
            scrollSnapType: 'y mandatory',
            WebkitOverflowScrolling: 'touch',
            position: 'relative',
            maskImage: 'linear-gradient(to bottom, transparent, black 20%, black 80%, transparent)',
            WebkitMaskImage: 'linear-gradient(to bottom, transparent, black 20%, black 80%, transparent)',
            WebkitAppearance: 'none',
            scrollbarWidth: 'none',
            msOverflowStyle: 'none',
            userSelect: 'none',
            WebkitUserSelect: 'none',
            MozUserSelect: 'none',
            MsUserSelect: 'none',
          };

          const scrollbarHiddenStyle = `
            .wheel-picker-container::-webkit-scrollbar {
              display: none;
            }
          `;

          const wheelItemStyle = (index) => {
            const currentActualIndex = options.indexOf(selectedValue);
            const currentPaddedSelected = currentActualIndex !== -1 ? currentActualIndex + paddingItemsCount : paddingItemsCount;

            const offset = index - currentPaddedSelected;
            const distance = Math.abs(offset);
            const scaleFactor = 1 - distance * 0.1;
            const opacity = 1 - distance * 0.2;

            return {
              height: `${itemHeight}px`,
              lineHeight: `${itemHeight}px`,
              textAlign: 'center',
              fontSize: '24px',
              fontWeight: 'bold',
              color: paddedOptions[index] === selectedValue ? '#FFD700' : '#E5E7EB',
              transition: isDraggingWheel.current ? 'none' : 'transform 0.2s ease-out, opacity 0.2s ease-out, color 0.2s ease-out',
              transform: `scale(${Math.max(0.7, scaleFactor)})`,
              opacity: Math.max(0.3, opacity),
              scrollSnapAlign: 'center',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '100%',
              userSelect: 'none',
              WebkitUserSelect: 'none',
              MozUserSelect: 'none',
              MsUserSelect: 'none',
            };
          };

          return (
            React.createElement(React.Fragment, null,
              React.createElement('style', null, scrollbarHiddenStyle),
              React.createElement('div', {
                ref: wheelRef,
                style: wheelContainerStyle,
                className: `rounded-lg bg-gray-700 overflow-hidden wheel-picker-container ${className}`,
                onMouseDown: handleWheelStart,
                onTouchStart: handleWheelStart,
              },
                paddedOptions.map((option, index) => (
                  React.createElement('div', {
                    key: index,
                    style: wheelItemStyle(index),
                    className: 'cursor-pointer',
                  },
                    option !== null ? displayTransform(option) : ''
                  )
                ))
              )
            )
          );
        };

        // TimeSignatureModal component
        const TimeSignatureModal = ({ beatsPerMeasure, setBeatsPerMeasure, beatUnit, setBeatUnit, onClose }) => {
          const numeratorOptions = Array.from({ length: 12 }, (_, i) => i + 1);
          const denominatorOptions = [1, 2, 4, 8, 16];
          const itemHeight = 40;

          const [localNumerator, setLocalNumerator] = useState(beatsPerMeasure);
          const [localDenominator, setLocalDenominator] = useState(beatUnit);

          useEffect(() => {
            setLocalNumerator(beatsPerMeasure);
          }, [beatsPerMeasure]);

          useEffect(() => {
            setLocalDenominator(beatUnit);
          }, [beatUnit]);

          const handleNumeratorChange = useCallback((newValue) => {
            setLocalNumerator(newValue);
            setBeatsPerMeasure(newValue);
          }, [setBeatsPerMeasure]);

          const handleDenominatorChange = useCallback((newValue) => {
            setLocalDenominator(newValue);
            setBeatUnit(newValue);
          }, [setBeatUnit]);

          return (
            React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50' },
              React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative' },
                React.createElement('button', {
                  onClick: onClose,
                  className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                }, '×'),
                React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'Time Signature'),
                React.createElement('div', { className: 'flex justify-center items-center space-x-4' },
                  React.createElement(WheelPicker, {
                    options: numeratorOptions,
                    selectedValue: localNumerator,
                    onValueChange: handleNumeratorChange,
                    itemHeight: itemHeight,
                    className: 'w-32',
                  }),
                  React.createElement('span', { className: 'text-5xl font-bold text-yellow-300' }, '/'),
                  React.createElement(WheelPicker, {
                    options: denominatorOptions,
                    selectedValue: localDenominator,
                    onValueChange: handleDenominatorChange,
                    itemHeight: itemHeight,
                    className: 'w-32',
                  })
                )
              )
            )
          );
        };

        // IncrementPracticeModal component
        const IncrementPracticeModal = ({ bpm, setBpm, MIN_BPM, MAX_BPM, onClose }) => {
          const [incrementAmount, setIncrementAmount] = useState(1);

          const handleIncrement = (direction) => {
            setBpm(prevBpm => {
              let newBpm = prevBpm;
              if (direction === 'faster') {
                newBpm = prevBpm + incrementAmount;
              } else {
                newBpm = prevBpm - incrementAmount;
              }
              return Math.max(MIN_BPM, Math.min(MAX_BPM, newBpm));
            });
          };

          return (
            React.createElement('div', { className: 'fixed inset-x-0 bottom-0 top-1/2 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' },
              React.createElement('div', { className: 'bg-gray-800 rounded-t-2xl p-8 w-full max-w-md text-white shadow-2xl border border-gray-700 relative' },
                React.createElement('button', {
                  onClick: onClose,
                  className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                }, '×'),
                React.createElement('h2', { className: 'text-3xl font-bold mb-8 text-center text-yellow-300' }, 'Increment Practice'),
                React.createElement('div', { className: 'mb-8' },
                  React.createElement('h3', { className: 'text-xl font-semibold mb-3 text-left flex items-center' },
                    'Increment by: ',
                    React.createElement('span', { className: 'ml-2 text-yellow-300' }, `${incrementAmount} BPM`)
                  ),
                  React.createElement('input', {
                    type: 'range',
                    min: '1',
                    max: '5',
                    step: '1',
                    value: incrementAmount,
                    onChange: (e) => setIncrementAmount(Number(e.target.value)),
                    className: `w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg
                      [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:shadow-lg
                      [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:appearance-none [&::-moz-range-thumb]:shadow-lg`
                  })
                ),
                React.createElement('div', { className: 'flex justify-center space-x-4' },
                  React.createElement('button', {
                    onClick: () => handleIncrement('faster'),
                    className: 'flex-1 py-4 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-green-500 hover:bg-green-600 text-white',
                  }, 'Faster!'),
                  React.createElement('button', {
                    onClick: () => handleIncrement('slower'),
                    className: 'flex-1 py-4 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-red-600 hover:bg-red-700 text-white',
                  }, 'Slower!!')
                )
              )
            )
          );
        };

        // RepetitionsTracker Component
        const RepetitionsTracker = ({ onClose }) => {
          const ProgressBar = ({ currentStreak, goal }) => {
              const progress = (currentStreak / goal) * 100;
              const barColor = progress >= 100 ? 'bg-green-500' : 'bg-purple-500';

              return (
                  React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden' },
                      React.createElement('div', {
                          className: `${barColor} h-full rounded-full transition-all duration-300 ease-out`,
                          style: { width: `${Math.min(progress, 100)}%` },
                      })
                  )
              );
          };

          const RepsTrackerSettingsMenu = ({ currentGoal, setGoal, isMicrobreakEnabled, setIsMicrobreakEnabled, onClose }) => {
              const [tempGoal, setTempGoal] = useState(currentGoal);
              const [tempMicrobreakEnabled, setTempMicrobreakEnabled] = useState(isMicrobreakEnabled);

              const handleGoalChange = (e) => {
                  const value = parseInt(e.target.value, 10);
                  if (!isNaN(value) && value >= 5 && value <= 15) {
                      setTempGoal(value);
                  } else if (e.target.value === '') {
                      setTempGoal('');
                  }
              };

              const handleMicrobreakToggle = () => {
                  setTempMicrobreakEnabled(prev => !prev);
              };

              const handleSave = () => {
                  if (tempGoal >= 5 && tempGoal <= 15) {
                      setGoal(tempGoal);
                      setIsMicrobreakEnabled(tempMicrobreakEnabled);
                      onClose();
                  } else {
                      console.error("Please enter a number between 5 and 15 for repetitions.");
                  }
              };

              return (
                  React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4' },
                      React.createElement('div', { className: 'bg-white rounded-lg shadow-2xl p-6 max-w-xs w-full text-center relative' },
                          React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-4' }, 'Settings'),
                          React.createElement('div', { className: 'mb-6' },
                              React.createElement('label', { htmlFor: 'repetitions', className: 'block text-gray-700 text-lg font-semibold mb-2' }, 'Repetitions Needed:'),
                              React.createElement('input', {
                                  type: 'number',
                                  id: 'repetitions',
                                  value: tempGoal,
                                  onChange: handleGoalChange,
                                  min: '5',
                                  max: '15',
                                  className: 'w-full p-3 border border-gray-300 rounded-md text-center text-xl focus:ring-2 focus:ring-purple-400',
                              })
                          ),
                          React.createElement('div', { className: 'mb-6 flex items-center justify-between' },
                              React.createElement('span', { className: 'text-gray-700 text-lg font-semibold' }, 'Microbreak (10s on even reps):'),
                              React.createElement('label', { className: 'relative inline-flex items-center cursor-pointer' },
                                  React.createElement('input', { type: 'checkbox', value: '', className: 'sr-only peer', checked: tempMicrobreakEnabled, onChange: handleMicrobreakToggle }),
                                  React.createElement('div', { className: 'w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600' })
                              )
                          ),
                          React.createElement('button', {
                              onClick: handleSave,
                              className: 'w-full py-3 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold',
                          }, 'Save & Close')
                      )
                  )
              );
          };

          const [currentStreak, setCurrentStreak] = useState(0);
          const [completed, setCompleted] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [goalRepetitions, setGoalRepetitions] = useState(5);
          const [isMicrobreakEnabled, setIsMicrobreakEnabled] = useState(false);
          const [microbreakTimer, setMicrobreakTimer] = useState(0);

          useEffect(() => {
              if (currentStreak >= goalRepetitions && !completed) {
                  setCompleted(true);
              }
          }, [currentStreak, completed, goalRepetitions]);

          useEffect(() => {
              let timerInterval;
              if (microbreakTimer > 0) {
                  timerInterval = setInterval(() => {
                      setMicrobreakTimer(prev => prev - 1);
                  }, 1000);
              }
              return () => clearInterval(timerInterval);
          }, [microbreakTimer]);

          const handleCorrect = () => {
              if (completed || microbreakTimer > 0) {
                  return;
              }
              const nextStreak = currentStreak + 1;
              setCurrentStreak(nextStreak);
              if (isMicrobreakEnabled && nextStreak > 0 && nextStreak % 2 === 0 && nextStreak < goalRepetitions) {
                  setMicrobreakTimer(10);
              }
          };

          const handleIncorrect = () => {
              if (completed || microbreakTimer > 0) {
                  return;
              }
              setCurrentStreak(0);
              setMicrobreakTimer(0);
          };

          const handleReset = () => {
              setCurrentStreak(0);
              setCompleted(false);
              setMicrobreakTimer(0);
          };

          const buttonsDisabled = completed || microbreakTimer > 0;

          return (
              React.createElement('div', { className: 'fixed inset-x-0 bottom-0 top-1/2 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50' },
                  React.createElement('div', { className: 'bg-white rounded-t-2xl shadow-xl p-8 max-w-md w-full text-center relative' },
                      React.createElement('button', {
                        onClick: onClose,
                        className: 'absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl font-bold',
                      }, '×'),
                      showSettings && (
                          React.createElement(RepsTrackerSettingsMenu, {
                              currentGoal: goalRepetitions,
                              setGoal: setGoalRepetitions,
                              isMicrobreakEnabled: isMicrobreakEnabled,
                              setIsMicrobreakEnabled: setIsMicrobreakEnabled,
                              onClose: () => setShowSettings(false),
                          })
                      ),
                      React.createElement('div', { className: 'bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center relative' },
                          React.createElement('h1', { className: 'text-3xl font-bold text-gray-800 mb-6' }, `${goalRepetitions} Times in a Row Correctly!`),
                          React.createElement('button', {
                              onClick: () => setShowSettings(true),
                              className: 'absolute top-4 right-4 px-3 py-1 bg-gray-200 text-gray-700 rounded-md shadow-sm hover:bg-gray-300 transition-colors duration-200 text-sm',
                          }, 'Settings'),
                          React.createElement(ProgressBar, { currentStreak: currentStreak, goal: goalRepetitions }),
                          React.createElement('p', { className: 'text-xl text-gray-700 font-semibold mt-6 mb-8' },
                              'Current Streak: ',
                              React.createElement('span', { className: 'text-purple-600 text-3xl' }, currentStreak),
                              ' / ',
                              goalRepetitions
                          ),
                          microbreakTimer > 0 && (
                              React.createElement('div', { className: 'text-red-600 font-bold text-3xl mb-4 animate-pulse' }, `Microbreak: ${microbreakTimer}s`)
                          ),
                          React.createElement('div', { className: 'flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center' },
                              React.createElement('button', {
                                  onClick: handleCorrect,
                                  disabled: buttonsDisabled,
                                  className: `flex-1 w-full sm:w-auto aspect-square py-4 rounded-lg shadow-md text-white text-xl font-semibold transition-colors duration-200 flex flex-col items-center justify-center
                                      ${buttonsDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 active:bg-green-700'}`,
                              },
                                  React.createElement('span', { className: 'text-5xl mb-2' }, '👍'),
                                  ' ',
                                  React.createElement('span', null, 'Correct!')
                              ),
                              React.createElement('button', {
                                  onClick: handleIncorrect,
                                  disabled: buttonsDisabled,
                                  className: `flex-1 w-full sm:w-auto aspect-square py-4 rounded-lg shadow-md text-white text-xl font-semibold transition-colors duration-200 flex flex-col items-center justify-center
                                      ${buttonsDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600 active:bg-red-700'}`,
                              },
                                  React.createElement('span', { className: 'text-5xl mb-2' }, '👎'),
                                  ' ',
                                  React.createElement('span', null, 'Incorrect')
                              )
                          )
                      ),
                      completed && (
                          React.createElement('button', {
                              onClick: handleReset,
                              className: 'fixed bottom-8 left-1/2 transform -translate-x-1/2 px-8 py-4 rounded-lg shadow-xl bg-blue-600 text-white text-2xl font-bold hover:bg-blue-700 active:bg-blue-800 transition-colors duration-200 z-[51] pointer-events-auto',
                          }, 'Start New Passage')
                      )
                  )
              )
          );
        };

        // Victory Animation Component
        const VictoryAnimation = ({ goalRepetitions, studentName, onClose }) => {
            return (
                React.createElement('div', { className: 'fixed inset-0 z-60 flex items-center justify-center pointer-events-none' },
                    Array.from({ length: 500 }).map((_, i) => (
                        React.createElement('div', {
                            key: `confetti-${i}`,
                            className: 'absolute rounded-full opacity-100 animate-confetti-fall',
                            style: {
                                width: `${Math.random() * 15 + 5}px`,
                                height: `${Math.random() * 15 + 5}px`,
                                left: `${Math.random() * 100}%`,
                                animationDelay: `${Math.random() * 2}s`,
                                animationDuration: `${Math.random() * 5 + 3}s`,
                                backgroundColor: `hsl(${Math.random() * 360}, 90%, 70%)`,
                                transform: `scale(${Math.random() * 0.7 + 0.3}) rotate(${Math.random() * 720}deg)`,
                            },
                        })
                    )),
                    React.createElement('div', { className: 'absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center scale-0 animate-popup-grow relative z-10 border-4 border-yellow-400 pointer-events-auto' },
                        React.createElement('h2', { className: 'text-6xl font-bold text-green-600 mb-2 drop-shadow-lg animate-text-flash' }, '🎉 Great Job! 🎉'),
                        React.createElement('p', { className: 'text-4xl font-semibold text-purple-700 animate-text-flash-alt' }, `${goalRepetitions} in a Row!`),
                        React.createElement('button', {
                            onClick: onClose,
                            className: 'absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl font-bold',
                        }, '×')
                    ),
                    React.createElement('div', { className: 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 animate-brain-pop pointer-events-none' },
                        React.createElement('svg', { width: '200', height: '200', viewBox: '0 0 200 200', className: 'animate-brain-pulse' },
                            React.createElement('path', { d: 'M100 20 C 150 0, 190 50, 180 100 C 170 150, 130 190, 100 180 C 70 190, 30 150, 20 100 C 10 50, 50 0, 100 20 Z', fill: '#F0C2C2', stroke: '#D0A0A0', strokeWidth: '3' }),
                            React.createElement('path', { d: 'M100 25 Q105 100, 100 175', stroke: '#D0A0A0', strokeWidth: '4', fill: 'none' }),
                            React.createElement('path', { d: 'M60 40 Q70 30, 80 40 Q90 50, 80 60', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' }),
                            React.createElement('path', { d: 'M120 40 Q130 30, 140 40 Q150 50, 140 60', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' }),
                            React.createElement('path', { d: 'M40 90 Q50 80, 60 90 Q70 100, 60 110', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' }),
                            React.createElement('path', { d: 'M160 90 Q150 80, 140 90 Q130 100, 140 110', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' }),
                            React.createElement('path', { d: 'M70 150 Q80 140, 90 150 Q100 160, 90 170', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' }),
                            React.createElement('path', { d: 'M110 150 Q120 140, 130 150 Q140 160, 130 170', stroke: '#D0A0A0', strokeWidth: '2', fill: 'none' })
                        ),
                        React.createElement('div', { className: 'absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 mt-[-10px] ml-[0px] animate-sign-swing' },
                            React.createElement('div', { className: 'bg-yellow-400 border-4 border-yellow-600 rounded-lg p-3 shadow-lg animate-sign-wobble' },
                                React.createElement('p', { className: 'text-xl font-bold text-red-700 whitespace-nowrap' }, 'Well Done!')
                            )
                        )
                    )
                )
            );
        };

        // PracticeToolsMenu component
        const PracticeToolsMenu = ({ setActiveModal, onClose, generatePracticeIdea, isGeneratingIdea }) => {
          return (
            React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50' },
              React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative' },
                React.createElement('button', {
                  onClick: onClose,
                  className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                }, '×'),
                React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'Practice Tools'),
                React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
                  React.createElement('button', {
                    onClick: () => setActiveModal('incrementPractice'),
                    className: 'py-4 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-blue-500 hover:bg-blue-600 text-white',
                  }, 'Incremental Practice'),
                  React.createElement('button', {
                    onClick: () => setActiveModal('repetitionsTracker'),
                    className: 'py-4 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-purple-500 hover:bg-purple-600 text-white',
                  }, 'Repetitions Tracker'),
                  React.createElement('button', {
                    onClick: generatePracticeIdea,
                    className: 'w-full py-3 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-yellow-500 hover:bg-yellow-600 text-white flex items-center justify-center',
                    disabled: isGeneratingIdea,
                  },
                    isGeneratingIdea ? (
                      React.createElement('svg', { className: 'animate-spin h-5 w-5 text-white mr-3', viewBox: '0 0 24 24' },
                        React.createElement('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                        React.createElement('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                      )
                    ) : (
                      'Get Practice Idea ✨'
                    )
                  )
                )
              )
            )
          );
        };


        // Main App component
        const App = () => {
          const MIN_BPM = 40;
          const MAX_BPM = 300;

          const [bpm, setBpm] = useState(120);
          const [isRunning, setIsRunning] = useState(false);
          const [beatCount, setBeatCount] = useState(0);
          const [armAngle, setArmAngle] = useState(0);
          const [dialRotation, setDialRotation] = useState(0);
          const [metronomeVolume, setMetronomeVolume] = useState(100);

          const [beatsPerMeasure, setBeatsPerMeasure] = useState(4);
          const [beatUnit, setBeatUnit] = useState(4);
          const [subdivisionType, setSubdivisionType] = useState('none');
          const [accentFirstBeat, setAccentFirstBeat] = useState(true);
          const [selectedSound, setSelectedSound] = useState('modernClick');

          const [activeModal, setActiveModal] = useState(null);

          const [practiceIdea, setPracticeIdea] = useState('');
          const [isGeneratingIdea, setIsGeneratingIdea] = useState(false);

          const [mutedBeats, setMutedBeats] = useState([]);

          const [isAdjustingTempo, setIsAdjustingTempo] = useState(false);

          const [showVictoryAnimation, setShowVictoryAnimation] = useState(false);
          const [victoryGoal, setVictoryGoal] = useState(5);
          const [victoryStudentName, setVictoryStudentName] = useState('');

          const [localBpmInput, setLocalBpmInput] = useState(String(bpm));
          const [isBpmInputFocused, setIsBpmInputFocused] = useState(false);

          const sineClickSynth = useRef(null);
          const traditionalPercussiveClickSynth = useRef(null);
          const sawtoothClickSynth = useRef(null);
          const bellSynth = useRef(null);

          // Dedicated refs for subdivision synths (initialized once)
          const sineSubdivisionSynth = useRef(null);
          const traditionalPercussiveSubdivisionSynth = useRef(null);
          const sawtoothSubdivisionSynth = useRef(null);


          const volumeNode = useRef(null);
          const transportRef = useRef(null);
          const mainBeatEventId = useRef(null);

          const internalBeatCounter = useRef(0);
          const animationFrameId = useRef(null);
          const dialRef = useRef(null);

          const isDraggingPendulum = useRef(false);
          const pendulumStartClientY = useRef(0);
          const initialPendulumBpm = useRef(0);

          const isDraggingDial = useRef(false);
          const startAngleOffset = useRef(0);

          const tapTimes = useRef([]);
          const tapTimeout = useRef(null);

          const holdIntervalRef = useRef(null);
          const holdStartTime = useRef(0);

          useEffect(() => {
            // Initialize main click synths
            sineClickSynth.current = new Tone.PolySynth(Tone.Synth, {
              oscillator: { type: "sine" },
              envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.05 },
            });

            traditionalPercussiveClickSynth.current = new Tone.MembraneSynth({
              pitchDecay: 0.02,
              octaves: 8,
              envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.05 },
              oscillator: { type: "sine" },
            });

            sawtoothClickSynth.current = new Tone.PolySynth(Tone.Synth, {
              oscillator: { type: "sawtooth" },
              envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.1 },
              volume: -3
            });

            bellSynth.current = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5,
                volume: -8
            });

            // Initialize subdivision synths (matching the main click types)
            sineSubdivisionSynth.current = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.05 },
                volume: -10, // Quieter than main modern click
            });
            traditionalPercussiveSubdivisionSynth.current = new Tone.MembraneSynth({
                pitchDecay: 0.02,
                octaves: 8,
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.05 },
                oscillator: { type: "sine" },
                volume: -10, // Quieter than main traditional click
            });
            sawtoothSubdivisionSynth.current = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.1 },
                volume: -10, // Quieter than main digital beep
            });


            volumeNode.current = new Tone.Volume(0).toDestination();

            // Connect ALL synths to the main volume node
            sineClickSynth.current.connect(volumeNode.current);
            traditionalPercussiveClickSynth.current.connect(volumeNode.current);
            sawtoothClickSynth.current.connect(volumeNode.current);
            bellSynth.current.connect(volumeNode.current);
            sineSubdivisionSynth.current.connect(volumeNode.current);
            traditionalPercussiveSubdivisionSynth.current.connect(volumeNode.current);
            sawtoothSubdivisionSynth.current.connect(volumeNode.current);

            transportRef.current = Tone.getTransport();
            transportRef.current.bpm.value = bpm;

            const initialDialAngle = ((bpm - MIN_BPM) / (MAX_BPM - MIN_BPM)) * 270 - 135;
            setDialRotation(initialDialAngle);

            return () => {
              // Dispose all synths on unmount
              if (sineClickSynth.current) sineClickSynth.current.dispose();
              if (traditionalPercussiveClickSynth.current) traditionalPercussiveClickSynth.current.dispose();
              if (sawtoothClickSynth.current) sawtoothClickSynth.current.dispose();
              if (bellSynth.current) bellSynth.current.dispose();
              if (sineSubdivisionSynth.current) sineSubdivisionSynth.current.dispose();
              if (traditionalPercussiveSubdivisionSynth.current) traditionalPercussiveSubdivisionSynth.current.dispose();
              if (sawtoothSubdivisionSynth.current) sawtoothSubdivisionSynth.current.dispose();
              if (volumeNode.current) volumeNode.current.dispose();
              if (transportRef.current) {
                transportRef.current.stop();
                transportRef.current.cancel();
              }
              if (mainBeatEventId.current) {
                transportRef.current.clear(mainBeatEventId.current);
              }
              if (animationFrameId.current) {
                cancelAnimationFrame(animationFrameId.current);
              }
              if (holdIntervalRef.current) clearInterval(holdIntervalRef.current);
              Tone.context.close();
            };
          }, []); // Empty dependency array means this runs only once on mount

          // Removed the useEffect that previously re-initialized subdivisionSynth on selectedSound change

          useEffect(() => {
            setMutedBeats(new Array(beatsPerMeasure).fill(false));
          }, [beatsPerMeasure]);

          useEffect(() => {
            if (transportRef.current) {
              transportRef.current.bpm.value = bpm;
            }
            const newDialAngle = ((bpm - MIN_BPM) / (MAX_BPM - MIN_BPM)) * 270 - 135;
            setDialRotation(newDialAngle);
            if (!isBpmInputFocused) {
                setLocalBpmInput(String(bpm));
            }
          }, [bpm, MIN_BPM, MAX_BPM, isBpmInputFocused]);

          useEffect(() => {
            if (volumeNode.current) {
              const minDb = -40;
              const maxDb = 0;
              const dbValue = (metronomeVolume / 100) * (maxDb - minDb) + minDb;
              volumeNode.current.volume.value = dbValue;
              volumeNode.current.mute = metronomeVolume === 0 || !isRunning || isAdjustingTempo;
            }
          }, [metronomeVolume, isRunning, isAdjustingTempo]);

          const playClick = useCallback((time) => {
            const currentAbsoluteBeat = internalBeatCounter.current;
            const currentMeasureBeat = currentAbsoluteBeat % beatsPerMeasure;
            const quarterNoteDuration = Tone.Time("4n").toSeconds();

            const isAccentedBeat = accentFirstBeat && currentMeasureBeat === 0;

            Tone.Draw.schedule(() => {
              setBeatCount(currentMeasureBeat);
            }, time);

            if (mutedBeats[currentMeasureBeat]) {
              internalBeatCounter.current = (internalBeatCounter.current + 1);
              return;
            }

            let currentSubdivisionSynth = null; // Declare and assign the correct subdivision synth
            switch (selectedSound) {
              case 'modernClick':
                currentSubdivisionSynth = sineSubdivisionSynth.current;
                sineClickSynth.current.triggerAttackRelease(isAccentedBeat ? "C5" : "C4", "8n", time);
                break;
              case 'digitalBeep':
                currentSubdivisionSynth = sawtoothSubdivisionSynth.current;
                sawtoothClickSynth.current.triggerAttackRelease(isAccentedBeat ? "C6" : "C5", "8n", time);
                break;
              case 'traditionalClickBell':
                currentSubdivisionSynth = traditionalPercussiveSubdivisionSynth.current;
                traditionalPercussiveClickSynth.current.triggerAttackRelease("G4", "8n", time, 0.6);
                if (isAccentedBeat) {
                  bellSynth.current.triggerAttackRelease("C6", "2n", time);
                }
                break;
            }

            const subdivisionPitch = "C3";
            const subdivisionVelocity = 0.4;

            if (currentSubdivisionSynth) { // Use the selected subdivision synth
              switch (subdivisionType) {
                case 'straight8ths':
                  currentSubdivisionSynth.triggerAttackRelease(subdivisionPitch, "16n", time + 0.5 * quarterNoteDuration, subdivisionVelocity);
                  break;
                case 'triplet_full':
                  currentSubdivisionSynth.triggerAttackRelease(subdivisionPitch, "16n", time + (1/3) * quarterNoteDuration, subdivisionVelocity);
                  currentSubdivisionSynth.triggerAttackRelease(subdivisionPitch, "16n", time + (2/3) * quarterNoteDuration, subdivisionVelocity);
                  break;
                case 'dotted8th16th':
                  currentSubdivisionSynth.triggerAttackRelease(subdivisionPitch, "16n", time + 0.75 * quarterNoteDuration, subdivisionVelocity);
                  break;
                case 'sixteenth_dotted8th':
                  currentSubdivisionSynth.triggerAttackRelease(subdivisionPitch, "16n", time + 0.25 * quarterNoteDuration, subdivisionVelocity);
                  break;
              }
            }
            internalBeatCounter.current = (internalBeatCounter.current + 1);
          }, [beatsPerMeasure, subdivisionType, accentFirstBeat, mutedBeats, selectedSound]); // Dependencies remain the same

          const updateArmAngle = useCallback(() => {
            if (!isRunning || !transportRef.current) {
              setArmAngle(0);
              return;
            }

            const currentTime = transportRef.current.seconds;
            const beatDuration = 60 / bpm;
            const progressInCycle = (currentTime % (beatDuration * 2)) / (beatDuration * 2);

            const newAngle = Math.sin(progressInCycle * 2 * Math.PI) * 45;
            setArmAngle(newAngle);

            animationFrameId.current = requestAnimationFrame(updateArmAngle);
          }, [isRunning, bpm]);

          useEffect(() => {
            if (transportRef.current) {
              transportRef.current.stop();
              transportRef.current.cancel();
            }
            if (mainBeatEventId.current) {
              mainBeatEventId.current = null;
            }
            if (animationFrameId.current) {
              cancelAnimationFrame(animationFrameId.current);
              animationFrameId.current = null;
            }

            internalBeatCounter.current = 0;
            setBeatCount(0);
            setArmAngle(0);

            if (isRunning) {
              // Ensure Tone.start() is called directly within a user gesture for mobile audio
              // This is crucial for audio to work on browsers like Chrome/Brave on Android
              if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    console.log("AudioContext resumed by user gesture.");
                }).catch(e => console.error("Error starting Tone.js AudioContext:", e));
              }

              mainBeatEventId.current = transportRef.current.scheduleRepeat(playClick, "4n", 0);
              transportRef.current.start();

              animationFrameId.current = requestAnimationFrame(updateArmAngle);
            }
          }, [isRunning, playClick, updateArmAngle, beatsPerMeasure, subdivisionType, accentFirstBeat, selectedSound]);

          const getAngleFromCoordinates = (centerX, centerY, mouseX, mouseY) => {
            return Math.atan2(mouseY - centerY, mouseX - centerX) * (180 / Math.PI);
          };

          const handleDialMouseDown = (e) => {
            e.preventDefault();
            isDraggingDial.current = true;
            setIsAdjustingTempo(true);
            const dialRect = dialRef.current.getBoundingClientRect();
            const centerX = dialRect.left + dialRect.width / 2;
            const centerY = dialRect.top + dialRect.height / 2;
            const initialMouseAngle = getAngleFromCoordinates(centerX, centerY, e.clientX, e.clientY);

            startAngleOffset.current = initialMouseAngle - dialRotation;

            window.addEventListener('mousemove', handleDialMouseMove);
            window.addEventListener('mouseup', handleDialMouseUp);
            window.addEventListener('touchmove', handleDialTouchMove, { passive: false });
            window.addEventListener('touchend', handleDialTouchEnd);
          };

          const handleDialMouseMove = useCallback((e) => {
            if (!isDraggingDial.current) return;

            const dialRect = dialRef.current.getBoundingClientRect();
            const centerX = dialRect.left + dialRect.width / 2;
            const centerY = dialRect.top + dialRect.height / 2;
            const currentMouseAngle = getAngleFromCoordinates(centerX, centerY, e.clientX, e.clientY);

            let newRotation = currentMouseAngle - startAngleOffset.current;

            if (newRotation > 180) newRotation -= 360;
            if (newRotation < -180) newRotation += 360;

            const minAngle = -135;
            const maxAngle = 135;
            newRotation = Math.max(minAngle, Math.min(maxAngle, newRotation));

            setDialRotation(newRotation);

            const normalizedAngle = (newRotation - minAngle) / (maxAngle - minAngle);
            const newBpm = Math.round(normalizedAngle * (MAX_BPM - MIN_BPM) + MIN_BPM);
            setBpm(newBpm);
          }, [dialRotation, MIN_BPM, MAX_BPM]);

          const handleDialMouseUp = useCallback(() => {
            isDraggingDial.current = false;
            setIsAdjustingTempo(false);
            window.removeEventListener('mousemove', handleDialMouseMove);
            window.removeEventListener('mouseup', handleDialMouseUp);
          }, []);

          const handleDialTouchStart = (e) => {
            e.preventDefault();
            isDraggingDial.current = true;
            setIsAdjustingTempo(true);
            const touch = e.touches[0];
            const dialRect = dialRef.current.getBoundingClientRect();
            const centerX = dialRect.left + dialRect.width / 2;
            const centerY = dialRect.top + dialRect.height / 2;
            const initialTouchAngle = getAngleFromCoordinates(centerX, centerY, touch.clientX, touch.clientY);

            startAngleOffset.current = initialTouchAngle - dialRotation;

            window.addEventListener('touchmove', handleDialTouchMove, { passive: false });
            window.addEventListener('touchend', handleDialTouchEnd);
          };

          const handleDialTouchMove = useCallback((e) => {
            if (!isDraggingDial.current) return;
            e.preventDefault();

            const touch = e.touches[0];
            const dialRect = dialRef.current.getBoundingClientRect();
            const centerX = dialRect.left + dialRect.width / 2;
            const centerY = dialRect.top + dialRect.height / 2;
            const currentTouchAngle = getAngleFromCoordinates(centerX, centerY, touch.clientX, touch.clientY);

            let newRotation = currentTouchAngle - startAngleOffset.current;

            if (newRotation > 180) newRotation -= 360;
            if (newRotation < -180) newRotation += 360;

            const minAngle = -135;
            const maxAngle = 135;
            newRotation = Math.max(minAngle, Math.min(maxAngle, newRotation));

            setDialRotation(newRotation);

            const normalizedAngle = (newRotation - minAngle) / (maxAngle - minAngle);
            const newBpm = Math.round(normalizedAngle * (MAX_BPM - MIN_BPM) + MIN_BPM);
            setBpm(newBpm);
          }, [dialRotation, MIN_BPM, MAX_BPM]);

          const handleDialTouchEnd = useCallback(() => {
            isDraggingDial.current = false;
            setIsAdjustingTempo(false);
            window.removeEventListener('touchmove', handleDialTouchMove);
            window.removeEventListener('touchend', handleDialTouchEnd);
          }, []);

          const getPendulumTopPosition = useCallback(() => {
            const minPendulumTopPx = 135;
            const maxPendulumTopPx = 27;
            const bpmRange = MAX_BPM - MIN_BPM;
            const pendulumMovementRange = minPendulumTopPx - maxPendulumTopPx;

            const normalizedBPM = (bpm - MIN_BPM) / bpmRange;

            const calculatedTop = minPendulumTopPx - (normalizedBPM * pendulumMovementRange);

            return Math.max(maxPendulumTopPx, Math.min(minPendulumTopPx, calculatedTop));
          }, [bpm, MIN_BPM, MAX_BPM]);

          const handlePendulumMouseDown = useCallback((e) => {
            e.preventDefault();
            e.stopPropagation();
            isDraggingPendulum.current = true;
            setIsAdjustingTempo(true);
            pendulumStartClientY.current = e.clientY;
            initialPendulumBpm.current = bpm;

            window.addEventListener('mousemove', handlePendulumMouseMove);
            window.addEventListener('mouseup', handlePendulumMouseUp);
          }, [bpm]);

          const handlePendulumTouchStart = useCallback((e) => {
            e.preventDefault();
            e.stopPropagation();
            isDraggingPendulum.current = true;
            setIsAdjustingTempo(true);
            pendulumStartClientY.current = e.touches[0].clientY;
            initialPendulumBpm.current = bpm;

            window.addEventListener('touchmove', handlePendulumTouchMove, { passive: false });
            window.addEventListener('touchend', handlePendulumTouchEnd);
          }, [bpm]);

          const handlePendulumMouseMove = useCallback((e) => {
            if (!isDraggingPendulum.current) return;

            const minPendulumTopPx = 135;
            const maxPendulumTopPx = 27;
            const pendulumMovementRange = minPendulumTopPx - maxPendulumTopPx;

            const bpmPerPixel = (MAX_BPM - MIN_BPM) / pendulumMovementRange;

            const currentClientY = e.clientY;
            const deltaYFromStart = currentClientY - pendulumStartClientY.current;

            let newBpm = initialPendulumBpm.current - (deltaYFromStart * bpmPerPixel);

            newBpm = Math.max(MIN_BPM, Math.min(MAX_BPM, newBpm));
            setBpm(Math.round(newBpm));

          }, [MIN_BPM, MAX_BPM]);

          const handlePendulumTouchMove = useCallback((e) => {
            if (!isDraggingPendulum.current) return;
            e.preventDefault();

            const minPendulumTopPx = 135;
            const maxPendulumTopPx = 27;
            const pendulumMovementRange = minPendulumTopPx - maxPendulumTopPx;

            const bpmPerPixel = (MAX_BPM - MIN_BPM) / pendulumMovementRange;

            const currentClientY = e.touches[0].clientY;
            const deltaYFromStart = currentClientY - pendulumStartClientY.current;

            let newBpm = initialPendulumBpm.current - (deltaYFromStart * bpmPerPixel);

            newBpm = Math.max(MIN_BPM, Math.min(MAX_BPM, newBpm));
            setBpm(Math.round(newBpm));
          }, [MIN_BPM, MAX_BPM]);

          const handlePendulumMouseUp = useCallback(() => {
            isDraggingPendulum.current = false;
            setIsAdjustingTempo(false);
            window.removeEventListener('mousemove', handlePendulumMouseMove);
            window.removeEventListener('mouseup', handlePendulumMouseUp);
          }, []);

          const handlePendulumTouchEnd = useCallback(() => {
            isDraggingPendulum.current = false;
            setIsAdjustingTempo(false);
            window.removeEventListener('touchmove', handlePendulumTouchMove);
            window.removeEventListener('touchend', handlePendulumTouchEnd);
          }, []);

          const handleTap = useCallback(() => {
            const currentTime = Date.now();
            tapTimes.current.push(currentTime);

            if (tapTimes.current.length > 1 && (currentTime - tapTimes.current[tapTimes.current.length - 2]) > 2000) {
              tapTimes.current = [currentTime];
            }

            if (tapTimes.current.length > 5) {
              tapTimes.current = tapTimes.current.slice(-5);
            }

            if (tapTimes.current.length >= 2) {
              let totalInterval = 0;
              for (let i = 1; i < tapTimes.current.length; i++) {
                totalInterval += (tapTimes.current[i] - tapTimes.current[i-1]);
              }
              const averageInterval = totalInterval / (tapTimes.current.length - 1);
              const calculatedBpm = Math.round(60000 / averageInterval);
              setBpm(Math.max(MIN_BPM, Math.min(MAX_BPM, calculatedBpm)));
            }

            if (tapTimeout.current) {
              clearTimeout(tapTimeout.current);
            }
            tapTimeout.current = setTimeout(() => {
              tapTimes.current = [];
            }, 2000);
          }, [setBpm, MIN_BPM, MAX_BPM]);

          const toggleMuteBeat = useCallback((indexToToggle) => {
            setMutedBeats(prevMutedBeats => {
              const newMutedBeats = [...prevMutedBeats];
              newMutedBeats[indexToToggle] = !newMutedBeats[indexToToggle];
              return newMutedBeats;
            });
          }, []);

          const startHoldingBpm = useCallback((direction) => {
            stopHoldingBpm();
            holdStartTime.current = Date.now();

            setIsAdjustingTempo(true);

            if (direction === 'up') {
              setBpm(prevBpm => Math.min(MAX_BPM, prevBpm + 1));
            } else {
              setBpm(prevBpm => Math.max(MIN_BPM, prevBpm - 1));
            }

            let lastStepTime = holdStartTime.current;

            holdIntervalRef.current = setInterval(() => {
              const currentTime = Date.now();
              const elapsedTime = currentTime - holdStartTime.current;
              const timeSinceLastStep = currentTime - lastStepTime;

              let currentStepAmount = 1;
              let currentEffectiveInterval = 200;
              const MAX_STEP_AMOUNT = 5;

              if (elapsedTime <= 1000) {
                currentStepAmount = 1;
                currentEffectiveInterval = 200;
              } else if (elapsedTime > 1000 && elapsedTime <= 2000) {
                const progress = (elapsedTime - 1000) / 1000;
                currentEffectiveInterval = 200 - (150 * progress);
                currentEffectiveInterval = Math.max(50, currentEffectiveInterval);
                currentStepAmount = Math.round(1 + (MAX_STEP_AMOUNT - 1) * progress);
                currentStepAmount = Math.max(1, currentStepAmount);
              } else {
                currentStepAmount = MAX_STEP_AMOUNT;
                currentEffectiveInterval = 50;
              }

              if (timeSinceLastStep >= currentEffectiveInterval) {
                if (direction === 'up') {
                  setBpm(prevBpm => Math.min(MAX_BPM, prevBpm + currentStepAmount));
                } else {
                  setBpm(prevBpm => Math.max(MIN_BPM, prevBpm - currentStepAmount));
                }
                lastStepTime = currentTime;
              }
            }, 10);

            window.addEventListener('mouseup', stopHoldingBpm);
            window.addEventListener('touchend', stopHoldingBpm);
          }, [MIN_BPM, MAX_BPM]);

          const stopHoldingBpm = useCallback(() => {
            if (holdIntervalRef.current) {
              clearInterval(holdIntervalRef.current);
              holdIntervalRef.current = null;
            }
            holdStartTime.current = 0;
            setIsAdjustingTempo(false);
            window.removeEventListener('mouseup', stopHoldingBpm);
            window.removeEventListener('touchend', stopHoldingBpm);
          }, []);

          const toggleMetronome = async () => { // Made async to await Tone.start()
            if (!isRunning && Tone.context.state !== 'running') {
              try {
                await Tone.start();
                console.log("AudioContext resumed by user gesture.");
              } catch (e) {
                console.error("Error starting Tone.js AudioContext:", e);
                // Optionally show a user-friendly message here
                return; // Prevent starting metronome if audio context failed
              }
            }
            setIsRunning(!isRunning);
          };

          const getSubdivisionDisplayName = (type) => {
            switch (type) {
              case 'none': return 'No Subdivision';
              case 'straight8ths': return '2x Quavers';
              case 'triplet_full': return 'Full Triplets';
              case 'dotted8th16th': return 'Dotted Quaver + Semiquaver';
              case 'sixteenth_dotted8th': return 'Semiquaver + Dotted Quaver';
              default: return 'Custom';
            }
          };

          const generatePracticeIdea = async () => {
            setIsGeneratingIdea(true);
            setPracticeIdea('');
            setActiveModal(null);

            const prompt = `Generate a very short (1-2 sentences) and creative rhythm practice idea for a musician aged 9-14, using a metronome.
            The current settings are:
            BPM: ${bpm}
            Time Signature: ${beatsPerMeasure}/${beatUnit}
            Subdivision: ${getSubdivisionDisplayName(subdivisionType)}

            Focus on how these settings can be used in a fun and engaging musical context. Avoid suggesting actions like "stomping your feet" or "robot" movements. Instead, focus on musicality, phrasing, dynamics, or specific instrument techniques. For example, if it's 1/4 and no subdivision, suggest playing a simple melody with a clear, steady pulse. If it's 3/4 and full triplets, suggest a graceful waltz-like improvisation. If it's dotted quaver + semiquaver, suggest a bouncy accompaniment.
            Do not include any introductory or concluding phrases like "Here's an or "I hope this helps!". Just the idea itself.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    setPracticeIdea(text);
                    setActiveModal('practiceIdea');
                } else {
                    setPracticeIdea('Could not generate an idea. Please try again.');
                    setActiveModal('practiceIdea');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                setPracticeIdea('Error generating idea. Please check your network connection.');
                setActiveModal('practiceIdea');
            } finally {
                setIsGeneratingIdea(false);
            }
          };

          return (
            React.createElement('div', { className: 'h-screen w-screen bg-gradient-to-br from-indigo-800 to-purple-900 flex items-center justify-center p-4 font-inter overflow-hidden' },
              React.createElement('div', { className: 'bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-2xl shadow-2xl p-6 w-full max-w-md text-center border border-white border-opacity-20 flex flex-col justify-between max-h-[98vh] overflow-y-auto' },
                React.createElement('div', { className: 'absolute top-4 left-4' },
                  React.createElement('button', {
                    onClick: () => setActiveModal('practiceTools'),
                    className: 'p-2 bg-white bg-opacity-20 rounded-lg shadow-md hover:bg-opacity-30 transition-colors duration-200 text-white text-sm font-bold',
                  }, 'Practice Tools')
                ),
                React.createElement('div', { className: 'absolute top-4 right-4 flex space-x-2' },
                  React.createElement('button', {
                    onClick: () => setActiveModal('settings'),
                    className: 'p-2 bg-white bg-opacity-20 rounded-lg shadow-md hover:bg-opacity-30 transition-colors duration-200',
                  },
                    React.createElement('svg', { className: 'w-6 h-6 text-white', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                      React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z' }),
                      React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' })
                    )
                  ),
                  React.createElement('button', {
                    onClick: () => setActiveModal('help'),
                    className: 'p-2 bg-white bg-opacity-20 rounded-lg shadow-md hover:bg-opacity-30 transition-colors duration-200',
                  }, React.createElement('span', { className: 'text-white text-xl font-bold' }, '?'))
                ),
                React.createElement('div', { className: 'flex justify-center space-x-2 mb-4' },
                  Array.from({ length: beatsPerMeasure }).map((_, index) => (
                    React.createElement('div', {
                      key: index,
                      onClick: () => toggleMuteBeat(index),
                      className: `relative w-8 h-8 rounded-full transition-all duration-150 ease-in-out cursor-pointer flex items-center justify-center
                        ${mutedBeats[index]
                          ? 'bg-gray-400'
                          : (isRunning && beatCount === index
                            ? 'bg-yellow-400 scale-125 shadow-lg'
                            : 'bg-gray-600')
                        }`
                    },
                      mutedBeats[index] && (
                        React.createElement('svg', { className: 'absolute w-5 h-5 text-white', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                          React.createElement('line', { x1: '18', y1: '6', x2: '6', y2: '18' }),
                          React.createElement('line', { x1: '6', y1: '6', x2: '18', y2: '18' })
                        )
                      )
                    )
                  ))
                ),
                React.createElement('div', { className: 'relative flex justify-center items-end mb-8 w-48 mx-auto', style: { height: '226px' } },
                  React.createElement('svg', { className: 'absolute bottom-0 z-0', width: '100%', height: '100%', viewBox: '0 0 100 180' },
                    React.createElement('path', {
                      d: 'M 20 170 L 80 170 C 85 170, 90 165, 90 160 L 90 20 C 90 15, 85 10, 80 10 L 20 10 C 15 10, 10 15, 10 20 L 10 160 C 10 165, 15 170, 20 170 Z',
                      fill: '#8B4513',
                      stroke: '#5A2D0A',
                      strokeWidth: '4',
                      strokeLinejoin: 'round',
                    }),
                    React.createElement('path', {
                      d: 'M 25 15 L 75 15 L 70 165 L 30 165 Z',
                      fill: '#FFFFFF',
                    }),
                    React.createElement('rect', { x: '0', y: '170', width: '100', height: '10', rx: '5', ry: '5', fill: '#EF4444' })
                  ),
                  React.createElement('div', {
                    className: 'absolute origin-bottom rounded-full z-30',
                    style: {
                      height: '172.8px',
                      width: '6.3px',
                      backgroundColor: '#FFD700',
                      transform: `translateX(-50%) rotate(${armAngle}deg)`,
                      transformOrigin: 'bottom center',
                      left: '50%',
                      bottom: '0',
                    },
                  },
                    React.createElement('div', {
                      className: 'absolute left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-gray-600 rounded-sm shadow-md cursor-grab active:cursor-grabbing',
                      style: {
                        top: `${getPendulumTopPosition()}px`,
                      },
                      onMouseDown: handlePendulumMouseDown,
                      onTouchStart: handlePendulumTouchStart,
                    })
                  ),
                  React.createElement('button', {
                    onClick: handleTap,
                    className: 'absolute w-40 h-12 bg-gray-800 flex items-center justify-center text-gray-200 text-xl font-bold rounded-b-xl z-40',
                    style: {
                      width: 'calc(80% + 8px)',
                      maxWidth: '160px',
                      left: '50%',
                      transform: 'translateX(-50%)',
                      bottom: '-25px',
                    },
                  }, 'TAP')
                ),
                React.createElement('div', { className: 'mb-4 flex items-center justify-center gap-2' },
                  React.createElement('button', {
                    onMouseDown: () => startHoldingBpm('down'),
                    onTouchStart: (e) => { e.preventDefault(); startHoldingBpm('down'); },
                    className: 'p-1 rounded-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold w-8 h-8 flex items-center justify-center transition-all duration-200',
                  }, '-'),
                  React.createElement('input', {
                    type: 'number',
                    value: isBpmInputFocused ? localBpmInput : bpm,
                    onFocus: () => {
                      setIsBpmInputFocused(true);
                      setLocalBpmInput(String(bpm));
                    },
                    onChange: (e) => setLocalBpmInput(e.target.value),
                    onBlur: () => {
                      const newBpm = parseInt(localBpmInput, 10);
                      if (!isNaN(newBpm)) {
                        setBpm(Math.max(MIN_BPM, Math.min(MAX_BPM, newBpm)));
                      } else {
                        setLocalBpmInput(String(bpm));
                      }
                      setIsBpmInputFocused(false);
                    },
                    onKeyDown: (e) => {
                      if (e.key === 'Enter') {
                        e.target.blur();
                      }
                    },
                    className: `text-4xl font-bold text-yellow-300 drop-shadow-xl mx-2 w-28 flex justify-center bg-transparent text-center focus:outline-none
                               appearance-none [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none`,
                    min: MIN_BPM,
                    max: MAX_BPM,
                  }),
                  React.createElement('span', { className: 'text-2xl text-yellow-200' }, 'BPM'),
                  React.createElement('button', {
                    onMouseDown: () => startHoldingBpm('up'),
                    onTouchStart: (e) => { e.preventDefault(); startHoldingBpm('up'); },
                    className: 'p-1 rounded-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold w-8 h-8 flex items-center justify-center transition-all duration-200',
                  }, '+')
                ),
                React.createElement('div', { className: 'flex items-center justify-center gap-4 mb-8' },
                  React.createElement('button', {
                    onClick: () => setActiveModal('timeSignature'),
                    className: 'w-20 h-20 flex-shrink-0 rounded-xl text-lg font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-blue-500 hover:bg-blue-600 text-white flex items-center justify-center',
                  }, `${beatsPerMeasure}/${beatUnit}`),
                  React.createElement('div', { className: 'relative flex justify-center items-center h-48 w-48 mx-auto flex-shrink-0' },
                    React.createElement('div', { className: 'absolute inset-0 bg-gray-900 rounded-full shadow-inner' }),
                    React.createElement('div', {
                      ref: dialRef,
                      className: 'absolute w-full h-full rounded-full flex justify-center items-start cursor-grab active:cursor-grabbing',
                      style: {
                        transform: `rotate(${dialRotation}deg)`,
                        transition: isDraggingDial.current ? 'none' : 'transform 0.1s ease-out',
                      },
                      onMouseDown: handleDialMouseDown,
                      onTouchStart: handleDialTouchStart,
                    },
                      React.createElement('div', { className: 'w-2 h-1/4 bg-white rounded-b-full shadow-lg', style: { transformOrigin: 'top center' } })
                    )
                  ),
                  React.createElement('button', {
                    onClick: () => setActiveModal('subdivision'),
                    className: 'w-20 h-20 flex-shrink-0 rounded-xl text-lg font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-blue-500 hover:bg-blue-600 text-white flex flex-col items-center justify-center',
                  },
                    React.createElement('div', { className: 'w-16 h-7 flex-shrink-0 mb-1 flex items-center justify-center' },
                      getSubdivisionVisual(subdivisionType, true)
                    ),
                    React.createElement('span', { className: 'text-xs font-medium' }, getSubdivisionDisplayName(subdivisionType))
                  )
                ),
                React.createElement('button', {
                  onClick: toggleMetronome,
                  className: `w-full py-4 rounded-xl text-2xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg
                    ${isRunning
                      ? 'bg-red-600 hover:bg-red-700 text-white'
                      : 'bg-green-500 hover:bg-green-600 text-white'
                    }`
                }, isRunning ? 'STOP' : 'START'),
                activeModal === 'settings' && (
                  React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50' },
                    React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative' },
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                      }, '×'),
                      React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'Settings'),
                      React.createElement('div', { className: 'mb-6' },
                        React.createElement('h3', { className: 'text-xl font-semibold mb-3 text-left flex items-center' },
                          'Volume: ',
                          React.createElement('span', { className: 'ml-2 text-yellow-300' }, metronomeVolume)
                        ),
                        React.createElement('input', {
                          type: 'range',
                          min: '0',
                          max: '100',
                          step: '1',
                          value: metronomeVolume,
                          onChange: (e) => setMetronomeVolume(Number(e.target.value)),
                          className: `w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg
                            [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:shadow-lg
                            [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:appearance-none [&::-moz-range-thumb]:shadow-lg`
                        })
                      ),
                      React.createElement('div', { className: 'mb-6' },
                        React.createElement('h3', { className: 'text-xl font-semibold mb-3 text-left' }, 'Accent First Beat:'),
                        React.createElement('div', { className: 'flex justify-center' },
                          React.createElement('button', {
                            onClick: () => setAccentFirstBeat(!accentFirstBeat),
                            className: `py-2 px-4 rounded-lg font-medium transition-colors duration-200 w-full
                              ${accentFirstBeat
                                ? 'bg-purple-600 text-white shadow-md'
                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                              }`
                          }, accentFirstBeat ? 'On' : 'Off')
                        )
                      ),
                      React.createElement('div', { className: 'mb-6' },
                        React.createElement('h3', { className: 'text-xl font-semibold mb-3 text-left' }, 'Metronome Sound:'),
                        React.createElement('div', { className: 'grid grid-cols-1 gap-2' },
                          React.createElement('button', {
                            onClick: () => setSelectedSound('modernClick'),
                            className: `py-2 px-4 rounded-lg font-medium transition-colors duration-200 w-full
                              ${selectedSound === 'modernClick' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`
                          }, 'Modern Click'),
                          React.createElement('button', {
                            onClick: () => setSelectedSound('digitalBeep'),
                            className: `py-2 px-4 rounded-lg font-medium transition-colors duration-200 w-full
                              ${selectedSound === 'digitalBeep' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`
                          }, 'Digital Beep'),
                          React.createElement('button', {
                            onClick: () => setSelectedSound('traditionalClickBell'),
                            className: `py-2 px-4 rounded-lg font-medium transition-colors duration-200 w-full
                              ${selectedSound === 'traditionalClickBell' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`
                          }, 'Traditional Click + Bell')
                        )
                      ),
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'w-full py-3 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-green-500 hover:bg-green-600 text-white',
                      }, 'Close')
                    )
                  )
                ),
                activeModal === 'subdivision' && (
                  React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50' },
                    React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative' },
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                      }, '×'),
                      React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'Subdivision'),
                      React.createElement('div', { className: 'grid grid-cols-1 gap-3' },
                        [
                          { type: 'none', name: 'No Subdivision' },
                          { type: 'straight8ths', name: '2x Quavers' },
                          { type: 'triplet_full', name: 'Full Triplets' },
                          { type: 'dotted8th16th', name: 'Dotted Quaver + Semiquaver' },
                          { type: 'sixteenth_dotted8th', name: 'Semiquaver + Dotted Quaver' },
                        ].map((option) => (
                          React.createElement('button', {
                            key: option.type,
                            onClick: () => {
                              setSubdivisionType(option.type);
                              setActiveModal(null);
                            },
                            className: `py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-start space-x-2
                              ${subdivisionType === option.type
                                ? 'bg-purple-600 text-white shadow-md'
                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                              }`
                          },
                            React.createElement('div', { className: 'w-24 flex-shrink-0' },
                              getSubdivisionVisual(option.type, subdivisionType === option.type)
                            ),
                            React.createElement('span', { className: 'flex-grow text-left' }, option.name)
                          )
                        ))
                      ),
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'w-full py-3 rounded-xl text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg bg-green-500 hover:bg-green-600 text-white mt-6',
                      }, 'Close')
                    )
                  )
                ),
                activeModal === 'timeSignature' && (
                  React.createElement(TimeSignatureModal, {
                    beatsPerMeasure: beatsPerMeasure,
                    setBeatsPerMeasure: setBeatsPerMeasure,
                    beatUnit: beatUnit,
                    setBeatUnit: setBeatUnit,
                    onClose: () => setActiveModal(null),
                  })
                ),
                activeModal === 'practiceTools' && (
                  React.createElement(PracticeToolsMenu, {
                    setActiveModal: setActiveModal,
                    onClose: () => setActiveModal(null),
                    generatePracticeIdea: generatePracticeIdea,
                    isGeneratingIdea: isGeneratingIdea,
                  })
                ),
                activeModal === 'incrementPractice' && (
                  React.createElement(IncrementPracticeModal, {
                    bpm: bpm,
                    setBpm: setBpm,
                    MIN_BPM: MIN_BPM,
                    MAX_BPM: MAX_BPM,
                    onClose: () => setActiveModal(null),
                  })
                ),
                activeModal === 'repetitionsTracker' && (
                  React.createElement(RepetitionsTracker, {
                    onClose: () => setActiveModal(null),
                  })
                ),
                activeModal === 'help' && (
                  React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50' },
                    React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative text-left' },
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                      }, '×'),
                      React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'User Guide'),
                      React.createElement('div', { className: 'space-y-4 text-sm md:text-base overflow-y-auto max-h-96 pr-2' },
                        React.createElement('div', null,
                          React.createElement('strong', null, 'BPM Dial:'), ' Drag the large central dial clockwise to increase BPM, counter-clockwise to decrease.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Pendulum:'), ' Drag the pendulum weight on the metronome arm up or down to adjust the BPM. Up for faster, down for slower.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'TAP Button:'), ' Tap this button at your desired tempo. The metronome will average your taps and set the BPM accordingly. If you pause for more than 2 seconds, the tap sequence resets.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Beat Indicators:'), ' The larger dots at the top show the current beat. Tap any dot to mute/unmute that specific beat. Muted beats will show a cross.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Settings (Gear Icon):'), ' Click the gear icon to open the settings menu. Here you can change:',
                          React.createElement('ul', { className: 'list-disc list-inside ml-4 mt-2' },
                            React.createElement('li', null, 'Volume'),
                            React.createElement('li', null, 'Accent First Beat (on/off)'),
                            React.createElement('li', null, 'Metronome Sound (Modern Click, Digital Beep, Traditional Click + Bell)')
                          )
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Time Signature Button:'), ' Click the square button displaying the time signature to open a dedicated menu for changing the time signature.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Subdivision Button:'), ' Click the square button displaying the subdivision visual to open a dedicated menu for changing subdivision type.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Help (? Icon):'), ' Opens this user guide.'
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'Practice Tools:'), ' Opens a menu with various practice aids, including:',
                          React.createElement('ul', { className: 'list-disc list-inside ml-4 mt-2' },
                            React.createElement('li', null, 'Incremental Practice: Incrementally increase or decrease the BPM by a chosen amount (1-5 BPM).'),
                            React.createElement('li', null, 'Repetitions Tracker: Track correct repetitions for focused practice, with optional microbreaks.'),
                            React.createElement('li', null, 'Get Practice Idea: Generates a short, creative practice suggestion based on the current metronome settings.')
                          )
                        ),
                        React.createElement('div', null,
                          React.createElement('strong', null, 'START/STOP:'), ' Toggles the metronome on and off.'
                        )
                      )
                    )
                  )
                ),
                activeModal === 'practiceIdea' && (
                  React.createElement('div', { className: 'fixed inset-0 flex items-start justify-center p-4 z-50' },
                    React.createElement('div', { className: 'bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-white shadow-2xl border border-gray-700 relative mt-8' },
                      React.createElement('button', {
                        onClick: () => setActiveModal(null),
                        className: 'absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold',
                      }, '×'),
                      React.createElement('h2', { className: 'text-3xl font-bold mb-6 text-center text-yellow-300' }, 'Practice Idea'),
                      React.createElement('p', { className: 'text-lg mb-4' }, practiceIdea)
                    )
                  )
                )
              ),
              showVictoryAnimation && (
                React.createElement(VictoryAnimation, {
                  goalRepetitions: victoryGoal,
                  studentName: victoryStudentName,
                  onClose: () => setShowVictoryAnimation(false),
                })
              )
            )
          );
        };

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(
          React.createElement(React.StrictMode, null, React.createElement(App, null))
        );
    </script>
</body>
</html>
